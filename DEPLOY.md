# Deploy Cleanly Backend to Render

## Prerequisites

- GitHub or GitLab account (to connect the repo to Render)
- Neon PostgreSQL database URL (you already have this in `.env`)
- Render account at [render.com](https://render.com)

## Option A: Deploy with Blueprint (render.yaml)

1. **Push your repo to GitHub/GitLab** (when you’re ready; you can use a private repo).

2. **Create a Render account** and connect your Git provider at [dashboard.render.com](https://dashboard.render.com).

3. **Create a new Blueprint**
   - Dashboard → **Blueprints** → **New Blueprint Instance**
   - Connect the repository that contains `render.yaml`
   - Render will detect `render.yaml` in the repo root

4. **Set environment variables**
   - In the **cleanly-api** service → **Environment**
   - Add:
     - **DATABASE_URL** = your Neon PostgreSQL URL (from project root `.env`)
     - **JWT_SECRET** is auto-generated by the Blueprint; you can leave it or set your own

5. **Deploy**
   - Click **Apply** (or let the Blueprint sync). Render will:
     - Use **Root Directory**: `backend`
     - Run **Build**: `npm install && npx prisma generate && npx prisma migrate deploy`
     - Run **Start**: `npm start`
     - Expose the service at `https://cleanly-api.onrender.com` (or your custom domain)

6. **Update the Android app**
   - In `app/build.gradle.kts` set:
   - `buildConfigField("String", "API_BASE_URL", "\"https://cleanly-api.onrender.com/api/v1/\"")`
   - Rebuild the app.

## Option B: Manual Web Service (no Blueprint)

1. **Push your repo** to GitHub/GitLab and connect it to Render.

2. **New Web Service**
   - Dashboard → **New** → **Web Service**
   - Select your **Cleanly** repository

3. **Configure**
   - **Name**: `cleanly-api`
   - **Region**: e.g. Singapore (or your choice)
   - **Root Directory**: `backend`
   - **Runtime**: Node
   - **Build Command**: `npm install && npx prisma generate && npx prisma migrate deploy`
   - **Start Command**: `npm start`
   - **Instance Type**: Free (or paid if you prefer)

4. **Environment variables** (in the service **Environment** tab)
   - `DATABASE_URL` = your Neon connection string (from `.env`)
   - `JWT_SECRET` = a long random string (e.g. from `openssl rand -base64 32`)
   - `JWT_ACCESS_EXPIRY` = `3600` (optional)
   - `JWT_REFRESH_EXPIRY` = `604800` (optional)

5. **Deploy**
   - Click **Create Web Service**. After the first deploy, your API will be at:
   - `https://<your-service-name>.onrender.com`

6. **Health check**
   - Open `https://<your-service-name>.onrender.com/api/v1/health` to confirm it’s running.

7. **Android app**
   - Set `API_BASE_URL` in `app/build.gradle.kts` to `https://<your-service-name>.onrender.com/api/v1/`
   - Rebuild and run the app.

## After deploy

- **Free tier**: The service may spin down after inactivity; the first request can be slow (cold start).
- **Database**: You’re using Neon; no extra Render Postgres needed.
- **Custom domain**: In the service → **Settings** → **Custom Domains** you can add your own domain and use it in `API_BASE_URL`.

## Troubleshooting

- **Build fails on Prisma**
  - Ensure **Root Directory** is `backend` so `prisma/schema.prisma` and `package.json` are found.
  - Ensure `DATABASE_URL` is set before the build (needed for `prisma migrate deploy`).

- **Runtime errors**
  - Check **Logs** in the Render dashboard.
  - Confirm `DATABASE_URL` and `JWT_SECRET` are set and that Neon allows connections from Render’s IPs (Neon usually allows all by default).

- **Android app can’t reach API**
  - Use the **HTTPS** URL (e.g. `https://cleanly-api.onrender.com/api/v1/`).
  - For Android 9+, cleartext (HTTP) is blocked by default; HTTPS is required for production.
